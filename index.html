<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.1</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #E8F5E8 0%, #D4F1D4 100%);
            --accent-color: #B8E6B8;
            --text-color: #2C3E50;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body {
            background: var(--primary-gradient);
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glassmorphism {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.15); 
        }

        .ce-item {
            background: linear-gradient(135deg, var(--ce-color), var(--ce-color-light));
            border-radius: 10px;
            padding: 8px 10px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 1px 6px rgba(0,0,0,0.08);
            font-size: 12px;
            cursor: grab;
            position: relative;
        }

        .ce-item.worktype-ope { --ce-color:#87CEEB; --ce-color-light:#B0E0E6; color:#1E3A8A;}
        .ce-item.worktype-me { --ce-color:#90EE90; --ce-color-light:#98FB98; color:#006400;}
        .ce-item.worktype-hd { --ce-color:#FFB6C1; --ce-color-light:#FFC0CB; color:#8B008B;}
        .ce-item.worktype-flex { --ce-color:#FFFF99; --ce-color-light:#FFFFE0; color:#B8860B;}

        .status-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #4CAF50;
            color: white;
            font-size: 8px;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }

        .status-æ—© { background: #FF9800; }
        .status-å½“ { background: #9C27B0; }
        .status-é { background: #607D8B; }
        .status-ä¼‘ { background: #F44336; }
        .status-å‡º { background: #2196F3; }

        .sidebar {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,0.3);
            min-height: 100vh;
            transition: all 0.3s ease;
            width: 60px;
            overflow: hidden;
        }

        .sidebar.expanded {
            width: 256px;
        }

        .sidebar-text {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar.expanded .sidebar-text {
            opacity: 1;
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
        }

        .sync-indicator.connected { 
            background: rgba(76,175,80,0.1); 
            color: #2E7D32; 
        }

        .sync-indicator.disconnected { 
            background: rgba(244,67,54,0.1); 
            color: #C62828; 
        }

        .sync-indicator.connecting { 
            background: rgba(255,193,7,0.1); 
            color: #F57C00; 
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .sync-dot.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .message {
            padding: 10px 14px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 2000;
            box-shadow: var(--shadow);
        }

        .message.success { background: rgba(76,175,80,0.95); color: #fff; }
        .message.error { background: rgba(244,67,54,0.95); color: #fff; }
        .message.info { background: rgba(33,150,243,0.95); color: #fff; }
        .message.warning { background: rgba(255,193,7,0.95); color: #111; }

        @media print {
            .sidebar, .message { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body>
    <div id="messageContainer"></div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="glassmorphism rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-6">
                <i class="fas fa-hospital text-4xl text-green-600 mb-3"></i>
                <h1 class="text-2xl font-bold text-gray-800 mb-1">CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.1</h1>
                <p class="text-gray-600 text-sm">GitHub Pages + Firebase ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼</label>
                    <select id="userId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" 
                            onchange="handleUserIdChange()" oninput="handleUserIdChange()">
                        <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</option>
                        <option value="ã‚¹ã‚¿ãƒƒãƒ•">ã‚¹ã‚¿ãƒƒãƒ•</option>
                        <option value="æ‰‹è¡“ãƒ»éº»é…”">æ‰‹è¡“ãƒ»éº»é…”</option>
                        <option value="MEã‚»ãƒ³ã‚¿ãƒ¼">MEã‚»ãƒ³ã‚¿ãƒ¼</option>
                        <option value="è¡€æ¶²æµ„åŒ–">è¡€æ¶²æµ„åŒ–</option>
                        <option value="ä¸æ•´è„ˆ">ä¸æ•´è„ˆ</option>
                        <option value="äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°">äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°</option>
                        <option value="å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«">å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«</option>
                        <option value="ãƒ¢ãƒ‹ã‚¿ãƒ¼">ãƒ¢ãƒ‹ã‚¿ãƒ¼</option>
                        <option value="ç®¡ç†è€…">ç®¡ç†è€…</option>
                    </select>
                </div>

                <div id="nameInputDiv" style="display:none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãŠåå‰</label>
                    <input id="nameInput" type="text" placeholder="ãŠåå‰ã‚’å…¥åŠ›" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"/>
                </div>

                <div id="securityCodeDiv" style="display:none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰</label>
                    <input id="securityInput" type="password" placeholder="ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"/>
                </div>

                <button id="loginButton" class="btn-primary w-full">
                    <i class="fas fa-sign-in-alt mr-2"></i>ãƒ­ã‚°ã‚¤ãƒ³
                </button>

                <div class="text-center">
                    <div id="syncStatus" class="sync-indicator connecting">
                        <div class="sync-dot pulse"></div>Firebaseæ¥ç¶šä¸­...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼ˆç°¡ç•¥ç‰ˆ - å‹•ä½œç¢ºèªå¾Œã«å®Œå…¨ç‰ˆã«å±•é–‹ï¼‰ -->
    <div id="mainInterface" style="display:none;" class="flex">
        <div id="sidebar" class="sidebar p-4">
            <div class="mb-3 flex justify-between items-center">
                <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-200">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="text-xs text-gray-600 sidebar-text">
                    <span id="currentUserDisplay">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                </div>
            </div>
            <div id="mainSyncStatus" class="sync-indicator connected">
                <div class="sync-dot pulse"></div>
                <span class="sidebar-text">åŒæœŸä¸­</span>
            </div>
        </div>
        
        <div class="flex-1 p-4">
            <h2 class="text-2xl font-bold mb-4">ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼</h2>
            <p class="text-gray-600 mb-4">CEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.1 ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚</p>
            <div class="glassmorphism rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-2">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span class="font-bold text-green-600" id="userDisplay"></span></p>
                        <p>ãƒ­ãƒ¼ãƒ«: <span class="font-bold" id="roleDisplay"></span></p>
                        <p>Firebase: <span class="font-bold text-green-600">æ¥ç¶šä¸­</span></p>
                    </div>
                    <div>
                        <p>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: <span class="font-bold">Ver.1</span></p>
                        <p>ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°: <span class="font-bold">GitHub Pages</span></p>
                        <p>çŠ¶æ…‹: <span class="font-bold text-green-600">æ­£å¸¸ç¨¼åƒä¸­</span></p>
                    </div>
                </div>
            </div>
            <button id="logoutButton" class="btn-primary mt-4">
                <i class="fas fa-sign-out-alt mr-2"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>
    </div>

    <script>
        // ========= Firebase è¨­å®š =========
        // ğŸ”¥ é‡è¦: å…ˆã»ã©å‹•ä½œç¢ºèªã§ããŸè¨­å®šå€¤ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
        const firebaseConfig = {
            apiKey: "AIzaSyBpfRTPDFFTEkWtuvksoF_hVkftQ__wH8Q",
  ã€€ã€€ã€€ã€€ã€€ã€€authDomain: "ce-scheduling-system.firebaseapp.com",
ã€€ã€€ã€€ã€€ã€€ã€€  databaseURL: "https://ce-scheduling-system-default-rtdb.asia-southeast1.firebasedatabase.app",
ã€€ã€€ã€€ã€€ã€€ã€€  projectId: "ce-scheduling-system",
 ã€€ã€€ã€€ã€€ã€€ã€€ storageBucket: "ce-scheduling-system.firebasestorage.app",
ã€€ã€€ã€€ã€€ã€€ã€€  messagingSenderId: "401096569342",
ã€€ã€€ã€€ã€€ã€€ã€€  appId: "1:401096569342:web:03b0a5f5bfd09e34ae90af",
ã€€ã€€ã€€ã€€ã€€ã€€  measurementId: "G-8C7X5WCED3"
        };

        // ========= ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =========
        let database = null;
        let auth = null;
        let isFirebaseReady = false;
        let currentUser = null;
        let userRole = null;

        // èªè¨¼è¨­å®š
        const AUTH_CREDENTIALS = {
            'ã‚¹ã‚¿ãƒƒãƒ•': { type: 'name', role: 'viewer' },
            'æ‰‹è¡“ãƒ»éº»é…”': { code: 'secure_SurgAnest_6917_ce_system', role: 'editor' },
            'MEã‚»ãƒ³ã‚¿ãƒ¼': { code: 'secure_MEcenter_6994_ce_system', role: 'editor' },
            'è¡€æ¶²æµ„åŒ–': { code: 'secure_Hemodialysis_6735_ce_system', role: 'editor' },
            'ä¸æ•´è„ˆ': { code: 'secure_Arrhythm_6551_ce_system', role: 'editor' },
            'äººå·¥å¿ƒè‚ºãƒ»è£œåŠ©å¾ªç’°': { code: 'secure_CpbEcmo_6288_ce_system', role: 'editor' },
            'å¿ƒãƒ»ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«': { code: 'secure_CardCath_6925_ce_system', role: 'editor' },
            'ãƒ¢ãƒ‹ã‚¿ãƒ¼': { code: 'secure_CEmonitor_1122_ce_system', role: 'monitor' },
            'ç®¡ç†è€…': { code: 'secure_CEadmin_5711_ce_system', role: 'admin' }
        };

        // ========= åˆæœŸåŒ– =========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSystem);
        } else {
            initializeSystem();
        }

        function initializeSystem() {
            console.log('ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
            try {
                setupAllEventListeners();
                handleUserIdChange(); // ğŸ”¥ åˆæœŸè¡¨ç¤ºã‚’ç¢ºå®Ÿã«è¨­å®š
                initializeFirebase();
                restoreLoginState();
                console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ========= FirebaseåˆæœŸåŒ– =========
        function initializeFirebase() {
            try {
                updateSyncStatus('connecting', 'Firebaseæ¥ç¶šä¸­...');
                
                // è¨­å®šå€¤æ¤œè¨¼
                if (firebaseConfig.messagingSenderId.includes('YOUR_') || firebaseConfig.appId.includes('YOUR_')) {
                    console.warn('âš ï¸ Firebaseè¨­å®šå€¤ã‚’æ›´æ–°ã—ã¦ãã ã•ã„');
                    updateSyncStatus('disconnected', 'Firebaseè¨­å®šæœªå®Œäº†');
                    showMessage('Firebaseè¨­å®šå€¤ã‚’å…ˆã»ã©å‹•ä½œç¢ºèªã§ããŸå€¤ã«æ›´æ–°ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                auth = firebase.auth();

                // æ¥ç¶šç›£è¦–
                database.ref('.info/connected').on('value', function(snapshot) {
                    if (snapshot.val() === true) {
                        console.log('âœ… Firebaseæ¥ç¶šæˆåŠŸ');
                        updateSyncStatus('connected', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­');
                        isFirebaseReady = true;
                    } else {
                        console.log('âŒ Firebaseæ¥ç¶šå¤±æ•—');
                        updateSyncStatus('disconnected', 'æ¥ç¶šå¤±æ•—');
                        isFirebaseReady = false;
                    }
                });

                // åŒ¿åèªè¨¼
                auth.signInAnonymously()
                    .then(() => {
                        console.log('âœ… FirebaseåŒ¿åèªè¨¼æˆåŠŸ');
                    })
                    .catch((error) => {
                        console.error('âŒ Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                        updateSyncStatus('disconnected', 'èªè¨¼å¤±æ•—');
                        showMessage('Firebaseèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    });

            } catch (error) {
                console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateSyncStatus('disconnected', 'åˆæœŸåŒ–å¤±æ•—');
                showMessage('FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ========= ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š =========
        function setupAllEventListeners() {
            console.log('ğŸ”„ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šé–‹å§‹');
            
            // ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
            const userId = document.getElementById('userId');
            const loginButton = document.getElementById('loginButton');
            const securityInput = document.getElementById('securityInput');
            const nameInput = document.getElementById('nameInput');
            
            if (userId && !userId.dataset.listenerSet) {
                userId.addEventListener('change', handleUserIdChange);
                userId.addEventListener('input', handleUserIdChange);
                userId.dataset.listenerSet = 'true';
            }
            
            if (loginButton && !loginButton.dataset.listenerSet) {
                loginButton.addEventListener('click', handleLogin);
                loginButton.dataset.listenerSet = 'true';
            }
            
            if (securityInput && !securityInput.dataset.listenerSet) {
                securityInput.addEventListener('keypress', e => { 
                    if (e.key === 'Enter') handleLogin(); 
                });
                securityInput.dataset.listenerSet = 'true';
            }
            
            if (nameInput && !nameInput.dataset.listenerSet) {
                nameInput.addEventListener('keypress', e => { 
                    if (e.key === 'Enter') handleLogin(); 
                });
                nameInput.dataset.listenerSet = 'true';
            }

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼
            const toggleSidebar = document.getElementById('toggleSidebar');
            if (toggleSidebar && !toggleSidebar.dataset.listenerSet) {
                toggleSidebar.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) sidebar.classList.toggle('expanded');
                });
                toggleSidebar.dataset.listenerSet = 'true';
            }

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton && !logoutButton.dataset.listenerSet) {
                logoutButton.addEventListener('click', handleLogout);
                logoutButton.dataset.listenerSet = 'true';
            }
            
            console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
        }

        // ========= ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† =========
        function handleUserIdChange() {
            console.log('ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå¤‰æ›´å‡¦ç†');
            const userId = document.getElementById('userId');
            const nameDiv = document.getElementById('nameInputDiv');
            const secDiv = document.getElementById('securityCodeDiv');
            
            if (!userId || !nameDiv || !secDiv) {
                console.error('âŒ å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const selectedValue = userId.value;
            console.log('é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼:', selectedValue);
            
            if (selectedValue === 'ã‚¹ã‚¿ãƒƒãƒ•') {
                console.log('âœ… åå‰å…¥åŠ›è¡¨ç¤º');
                nameDiv.style.display = 'block';
                secDiv.style.display = 'none';
            } else if (selectedValue && selectedValue !== '') {
                console.log('âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰å…¥åŠ›è¡¨ç¤º');
                nameDiv.style.display = 'none';
                secDiv.style.display = 'block';
            } else {
                console.log('âœ… å…¥åŠ›æ¬„éè¡¨ç¤º');
                nameDiv.style.display = 'none';
                secDiv.style.display = 'none';
            }
        }

        function handleLogin() {
            console.log('ğŸ”„ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹');
            
            const userId = document.getElementById('userId').value;
            const nameInput = document.getElementById('nameInput').value.trim();
            const securityInput = document.getElementById('securityInput').value;

            console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userId);
            console.log('åå‰å…¥åŠ›:', nameInput);
            console.log('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å…¥åŠ›:', securityInput ? 'å…¥åŠ›ã‚ã‚Š' : 'å…¥åŠ›ãªã—');

            if (!userId) {
                showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            const credential = AUTH_CREDENTIALS[userId];
            if (!credential) {
                showMessage('ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™', 'error');
                return;
            }

            let isValid = false;
            let displayName = userId;
            
            if (credential.type === 'name') {
                if (!nameInput) {
                    showMessage('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                isValid = true;
                displayName = nameInput;
                console.log('âœ… åå‰èªè¨¼æˆåŠŸ:', nameInput);
            } else {
                if (!securityInput) {
                    showMessage('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                isValid = securityInput === credential.code;
                if (isValid) {
                    displayName = userId;
                    console.log('âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰èªè¨¼æˆåŠŸ:', userId);
                } else {
                    console.log('âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰èªè¨¼å¤±æ•—');
                }
            }

            if (isValid) {
                userRole = credential.role;
                currentUser = displayName;
                
                // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ä¿å­˜ï¼ˆ24æ™‚é–“æœ‰åŠ¹ï¼‰
                const loginExpiry = Date.now() + (24 * 60 * 60 * 1000);
                localStorage.setItem('ceSystemLoggedInUser', JSON.stringify({
                    id: currentUser,
                    role: userRole,
                    loginTime: new Date().toISOString()
                }));
                localStorage.setItem('ceSystemLoginExpiry', loginExpiry.toString());
                console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ä¿å­˜ï¼ˆ24æ™‚é–“æœ‰åŠ¹ï¼‰');
                
                showMainInterface();
                showMessage(`${userId}ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ`, 'success');
            } else {
                showMessage('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function handleLogout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                currentUser = null;
                userRole = null;
                
                localStorage.removeItem('ceSystemLoggedInUser');
                localStorage.removeItem('ceSystemLoginExpiry');
                
                document.getElementById('mainInterface').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('userId').value = '';
                document.getElementById('nameInput').value = '';
                document.getElementById('securityInput').value = '';
                handleUserIdChange();
                
                showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
            }
        }

        function restoreLoginState() {
            try {
                const savedUser = localStorage.getItem('ceSystemLoggedInUser');
                const loginExpiry = localStorage.getItem('ceSystemLoginExpiry');
                
                if (savedUser && loginExpiry) {
                    const currentTime = Date.now();
                    const expiryTime = parseInt(loginExpiry);
                    
                    if (currentTime < expiryTime) {
                        const parsedUser = JSON.parse(savedUser);
                        currentUser = parsedUser.id;
                        userRole = parsedUser.role;
                        console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å¾©å…ƒ:', currentUser);
                        showMainInterface();
                        showMessage(`ãŠç–²ã‚Œæ§˜ã§ã™ã€${currentUser}ã•ã‚“ï¼`, 'info');
                        return;
                    } else {
                        localStorage.removeItem('ceSystemLoggedInUser');
                        localStorage.removeItem('ceSystemLoginExpiry');
                        console.log('ğŸ•’ ãƒ­ã‚°ã‚¤ãƒ³æœŸé™åˆ‡ã‚Œ');
                    }
                }
                
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainInterface').style.display = 'none';
            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainInterface').style.display = 'none';
            }
        }

        function showMainInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'flex';
            
            document.getElementById('currentUserDisplay').textContent = currentUser;
            document.getElementById('userDisplay').textContent = currentUser;
            document.getElementById('roleDisplay').textContent = userRole;
        }

        // ========= ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° =========
        function updateSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            const mainSyncStatus = document.getElementById('mainSyncStatus');
            
            const statusClasses = {
                'connecting': 'sync-indicator connecting',
                'connected': 'sync-indicator connected',
                'disconnected': 'sync-indicator disconnected'
            };
            
            if (syncStatus) {
                syncStatus.className = statusClasses[status] || 'sync-indicator disconnected';
                syncStatus.innerHTML = `<div class="sync-dot ${status === 'connected' ? 'pulse' : ''}"></div>${message}`;
            }
            
            if (mainSyncStatus) {
                mainSyncStatus.className = statusClasses[status] || 'sync-indicator disconnected';
                mainSyncStatus.innerHTML = `<div class="sync-dot ${status === 'connected' ? 'pulse' : ''}"></div><span class="sidebar-text">${message}</span>`;
            }
        }

        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const icons = {
                success: 'check',
                error: 'times',
                warning: 'exclamation',
                info: 'info'
            };
            
            messageDiv.innerHTML = `
                <i class="fas fa-${icons[type]}-circle"></i>
                ${text}
            `;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 4000);
        }

        // ========= ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹ =========
        window.handleUserIdChange = handleUserIdChange;
    </script>
</body>
</html>
