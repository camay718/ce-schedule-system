<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEスケジュール管理システム Ver.1</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #E8F5E8 0%, #D4F1D4 100%);
            --accent-color: #B8E6B8;
            --text-color: #2C3E50;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body {
            background: var(--primary-gradient);
            font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glassmorphism {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.15); 
        }

        .ce-item {
            background: linear-gradient(135deg, var(--ce-color), var(--ce-color-light));
            border-radius: 10px;
            padding: 8px 10px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 1px 6px rgba(0,0,0,0.08);
            font-size: 12px;
            cursor: grab;
            position: relative;
        }

        .ce-item.worktype-ope { --ce-color:#87CEEB; --ce-color-light:#B0E0E6; color:#1E3A8A;}
        .ce-item.worktype-me { --ce-color:#90EE90; --ce-color-light:#98FB98; color:#006400;}
        .ce-item.worktype-hd { --ce-color:#FFB6C1; --ce-color-light:#FFC0CB; color:#8B008B;}
        .ce-item.worktype-flex { --ce-color:#FFFF99; --ce-color-light:#FFFFE0; color:#B8860B;}

        .status-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #4CAF50;
            color: white;
            font-size: 8px;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }

        .status-早 { background: #FF9800; }
        .status-当 { background: #9C27B0; }
        .status-非 { background: #607D8B; }
        .status-休 { background: #F44336; }
        .status-出 { background: #2196F3; }

        .sidebar {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,0.3);
            min-height: 100vh;
            transition: all 0.3s ease;
            width: 60px;
            overflow: hidden;
        }

        .sidebar.expanded {
            width: 256px;
        }

        .sidebar-text {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar.expanded .sidebar-text {
            opacity: 1;
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
        }

        .sync-indicator.connected { 
            background: rgba(76,175,80,0.1); 
            color: #2E7D32; 
        }

        .sync-indicator.disconnected { 
            background: rgba(244,67,54,0.1); 
            color: #C62828; 
        }

        .sync-indicator.connecting { 
            background: rgba(255,193,7,0.1); 
            color: #F57C00; 
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .sync-dot.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .message {
            padding: 10px 14px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 2000;
            box-shadow: var(--shadow);
        }

        .message.success { background: rgba(76,175,80,0.95); color: #fff; }
        .message.error { background: rgba(244,67,54,0.95); color: #fff; }
        .message.info { background: rgba(33,150,243,0.95); color: #fff; }
        .message.warning { background: rgba(255,193,7,0.95); color: #111; }

        @media print {
            .sidebar, .message { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body>
    <div id="messageContainer"></div>

    <!-- ログイン画面 -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="glassmorphism rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-6">
                <i class="fas fa-hospital text-4xl text-green-600 mb-3"></i>
                <h1 class="text-2xl font-bold text-gray-800 mb-1">CEスケジュール管理システム Ver.1</h1>
                <p class="text-gray-600 text-sm">GitHub Pages + Firebase リアルタイム同期</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ユーザー</label>
                    <select id="userId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="">ユーザーを選択</option>
                        <option value="スタッフ">スタッフ</option>
                        <option value="手術・麻酔">手術・麻酔</option>
                        <option value="MEセンター">MEセンター</option>
                        <option value="血液浄化">血液浄化</option>
                        <option value="不整脈">不整脈</option>
                        <option value="人工心肺・補助循環">人工心肺・補助循環</option>
                        <option value="心・カテーテル">心・カテーテル</option>
                        <option value="モニター">モニター</option>
                        <option value="管理者">管理者</option>
                    </select>
                </div>

                <div id="nameInputDiv" style="display:none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">お名前</label>
                    <input id="nameInput" type="text" placeholder="お名前を入力" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"/>
                </div>

                <div id="securityCodeDiv" style="display:none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">セキュリティコード</label>
                    <input id="securityInput" type="password" placeholder="セキュリティコードを入力" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"/>
                </div>

                <button id="loginButton" class="btn-primary w-full">
                    <i class="fas fa-sign-in-alt mr-2"></i>ログイン
                </button>

                <div class="text-center">
                    <div id="syncStatus" class="sync-indicator connecting">
                        <div class="sync-dot pulse"></div>Firebase接続中...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- メイン画面（簡略版 - 動作確認用） -->
    <div id="mainInterface" style="display:none;" class="flex">
        <div id="sidebar" class="sidebar p-4">
            <div class="mb-3 flex justify-between items-center">
                <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-200">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="text-xs text-gray-600 sidebar-text">
                    <span id="currentUserDisplay">ユーザー</span>
                </div>
            </div>
            <div id="mainSyncStatus" class="sync-indicator connected">
                <div class="sync-dot pulse"></div>
                <span class="sidebar-text">同期中</span>
            </div>
        </div>
        
        <div class="flex-1 p-4">
            <h2 class="text-2xl font-bold mb-4">ログイン成功！</h2>
            <p class="text-gray-600 mb-4">CEスケジュール管理システム Ver.1 が正常に動作しています。</p>
            <div class="glassmorphism rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-2">システム状況</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p>ユーザー: <span class="font-bold text-green-600" id="userDisplay"></span></p>
                        <p>ロール: <span class="font-bold" id="roleDisplay"></span></p>
                        <p>Firebase: <span class="font-bold text-green-600">接続中</span></p>
                    </div>
                    <div>
                        <p>バージョン: <span class="font-bold">Ver.1</span></p>
                        <p>ホスティング: <span class="font-bold">GitHub Pages</span></p>
                        <p>状態: <span class="font-bold text-green-600">正常稼働中</span></p>
                    </div>
                </div>
            </div>
            <button id="logoutButton" class="btn-primary mt-4">
                <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
            </button>
        </div>
    </div>

    <script>
        // ========= Firebase 設定 =========
        // 🔥 重要: 以下をFirebase Consoleから取得した実際の値に置き換えてください
        const firebaseConfig = {
            apiKey: "AIzaSyBpfRTPDFFTEkWtuvksoF_hVkftQ__wH8Q",
  　　　　　　authDomain: "ce-scheduling-system.firebaseapp.com",
  　　　　　　databaseURL: "https://ce-scheduling-system-default-rtdb.asia-southeast1.firebasedatabase.app",
　　　　　　  projectId: "ce-scheduling-system",
  　　　　　　storageBucket: "ce-scheduling-system.firebasestorage.app",
  　　　　　　messagingSenderId: "401096569342",
  　　　　　　appId: "1:401096569342:web:03b0a5f5bfd09e34ae90af",
 　　　　　　 measurementId: "G-8C7X5WCED3"
　　　　};

        // ========= グローバル変数 =========
        let database = null;
        let auth = null;
        let isFirebaseReady = false;
        let currentUser = null;
        let userRole = null;

        // 認証設定
        const AUTH_CREDENTIALS = {
            'スタッフ': { type: 'name', role: 'viewer' },
            '手術・麻酔': { code: 'secure_SurgAnest_6917_ce_system', role: 'editor' },
            'MEセンター': { code: 'secure_MEcenter_6994_ce_system', role: 'editor' },
            '血液浄化': { code: 'secure_Hemodialysis_6735_ce_system', role: 'editor' },
            '不整脈': { code: 'secure_Arrhythm_6551_ce_system', role: 'editor' },
            '人工心肺・補助循環': { code: 'secure_CpbEcmo_6288_ce_system', role: 'editor' },
            '心・カテーテル': { code: 'secure_CardCath_6925_ce_system', role: 'editor' },
            'モニター': { code: 'secure_CEmonitor_1122_ce_system', role: 'monitor' },
            '管理者': { code: 'secure_CEadmin_5711_ce_system', role: 'admin' }
        };

        // ========= 初期化 =========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSystem);
        } else {
            initializeSystem();
        }

        function initializeSystem() {
            console.log('🔄 システム初期化開始');
            try {
                setupAllEventListeners();
                initializeFirebase();
                restoreLoginState();
                console.log('✅ システム初期化完了');
            } catch (error) {
                console.error('❌ 初期化エラー:', error);
                showMessage('システム初期化でエラーが発生しました', 'error');
            }
        }

        // ========= Firebase初期化 =========
        function initializeFirebase() {
            try {
                updateSyncStatus('connecting', 'Firebase接続中...');
                
                // 設定値検証
                if (firebaseConfig.messagingSenderId.includes('YOUR_') || firebaseConfig.appId.includes('YOUR_')) {
                    console.warn('⚠️ Firebase設定値が未設定です');
                    updateSyncStatus('disconnected', 'Firebase設定未完了');
                    showMessage('Firebase設定値を更新してください', 'warning');
                    return;
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                auth = firebase.auth();

                // 接続監視
                database.ref('.info/connected').on('value', function(snapshot) {
                    if (snapshot.val() === true) {
                        console.log('✅ Firebase接続成功');
                        updateSyncStatus('connected', 'リアルタイム同期中');
                        isFirebaseReady = true;
                    } else {
                        console.log('❌ Firebase接続失敗');
                        updateSyncStatus('disconnected', '接続失敗');
                        isFirebaseReady = false;
                    }
                });

                // 匿名認証
                auth.signInAnonymously()
                    .then(() => {
                        console.log('✅ Firebase匿名認証成功');
                    })
                    .catch((error) => {
                        console.error('❌ Firebase認証エラー:', error);
                        updateSyncStatus('disconnected', '認証失敗');
                        showMessage('Firebase認証に失敗しました', 'error');
                    });

            } catch (error) {
                console.error('❌ Firebase初期化エラー:', error);
                updateSyncStatus('disconnected', '初期化失敗');
                showMessage('Firebase初期化に失敗しました', 'error');
            }
        }

        // ========= イベントリスナー設定 =========
        function setupAllEventListeners() {
            // ユーザーID変更
            document.getElementById('userId').addEventListener('change', handleUserIdChange);
            document.getElementById('userId').addEventListener('input', handleUserIdChange);
            
            // ログイン
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            document.getElementById('securityInput').addEventListener('keypress', e => { 
                if (e.key === 'Enter') handleLogin(); 
            });
            document.getElementById('nameInput').addEventListener('keypress', e => { 
                if (e.key === 'Enter') handleLogin(); 
            });

            // サイドバー
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('expanded');
            });

            // ログアウト
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
        }

        // ========= ログイン処理 =========
        function handleUserIdChange() {
            const userId = document.getElementById('userId').value;
            const nameDiv = document.getElementById('nameInputDiv');
            const secDiv = document.getElementById('securityCodeDiv');
            
            if (userId === 'スタッフ') {
                nameDiv.style.display = 'block';
                secDiv.style.display = 'none';
            } else if (userId) {
                nameDiv.style.display = 'none';
                secDiv.style.display = 'block';
            } else {
                nameDiv.style.display = 'none';
                secDiv.style.display = 'none';
            }
        }

        function handleLogin() {
            const userId = document.getElementById('userId').value;
            const nameInput = document.getElementById('nameInput').value.trim();
            const securityInput = document.getElementById('securityInput').value;

            if (!userId) {
                showMessage('ユーザーを選択してください', 'warning');
                return;
            }

            const credential = AUTH_CREDENTIALS[userId];
            if (!credential) {
                showMessage('無効なユーザーです', 'error');
                return;
            }

            let isValid = false;
            let displayName = userId;
            
            if (credential.type === 'name') {
                if (!nameInput) {
                    showMessage('お名前を入力してください', 'warning');
                    return;
                }
                isValid = true;
                displayName = nameInput;
            } else {
                if (!securityInput) {
                    showMessage('セキュリティコードを入力してください', 'warning');
                    return;
                }
                isValid = securityInput === credential.code;
            }

            if (isValid) {
                userRole = credential.role;
                currentUser = displayName;
                
                // ログイン状態保存（24時間有効）
                const loginExpiry = Date.now() + (24 * 60 * 60 * 1000);
                localStorage.setItem('ceSystemLoggedInUser', JSON.stringify({
                    id: currentUser,
                    role: userRole,
                    loginTime: new Date().toISOString()
                }));
                localStorage.setItem('ceSystemLoginExpiry', loginExpiry.toString());
                
                showMainInterface();
                showMessage(`${userId}としてログインしました`, 'success');
            } else {
                showMessage('認証に失敗しました', 'error');
            }
        }

        function handleLogout() {
            if (confirm('ログアウトしてもよろしいですか？')) {
                currentUser = null;
                userRole = null;
                
                localStorage.removeItem('ceSystemLoggedInUser');
                localStorage.removeItem('ceSystemLoginExpiry');
                
                document.getElementById('mainInterface').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                
                // フォームリセット
                document.getElementById('userId').value = '';
                document.getElementById('nameInput').value = '';
                document.getElementById('securityInput').value = '';
                handleUserIdChange();
                
                showMessage('ログアウトしました', 'info');
            }
        }

        function restoreLoginState() {
            try {
                const savedUser = localStorage.getItem('ceSystemLoggedInUser');
                const loginExpiry = localStorage.getItem('ceSystemLoginExpiry');
                
                if (savedUser && loginExpiry) {
                    const currentTime = Date.now();
                    const expiryTime = parseInt(loginExpiry);
                    
                    if (currentTime < expiryTime) {
                        const parsedUser = JSON.parse(savedUser);
                        currentUser = parsedUser.id;
                        userRole = parsedUser.role;
                        showMainInterface();
                        showMessage(`お疲れ様です、${currentUser}さん！`, 'info');
                        return;
                    } else {
                        localStorage.removeItem('ceSystemLoggedInUser');
                        localStorage.removeItem('ceSystemLoginExpiry');
                    }
                }
                
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainInterface').style.display = 'none';
            } catch (error) {
                console.error('❌ ログイン状態復元エラー:', error);
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainInterface').style.display = 'none';
            }
        }

        function showMainInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'flex';
            
            document.getElementById('currentUserDisplay').textContent = currentUser;
            document.getElementById('userDisplay').textContent = currentUser;
            document.getElementById('roleDisplay').textContent = userRole;
        }

        // ========= ヘルパー関数 =========
        function updateSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            const mainSyncStatus = document.getElementById('mainSyncStatus');
            
            const statusClasses = {
                'connecting': 'sync-indicator connecting',
                'connected': 'sync-indicator connected',
                'disconnected': 'sync-indicator disconnected'
            };
            
            if (syncStatus) {
                syncStatus.className = statusClasses[status] || 'sync-indicator disconnected';
                syncStatus.innerHTML = `<div class="sync-dot ${status === 'connected' ? 'pulse' : ''}"></div>${message}`;
            }
            
            if (mainSyncStatus) {
                mainSyncStatus.className = statusClasses[status] || 'sync-indicator disconnected';
                mainSyncStatus.innerHTML = `<div class="sync-dot ${status === 'connected' ? 'pulse' : ''}"></div><span class="sidebar-text">${message}</span>`;
            }
        }

        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const icons = {
                success: 'check',
                error: 'times',
                warning: 'exclamation',
                info: 'info'
            };
            
            messageDiv.innerHTML = `
                <i class="fas fa-${icons[type]}-circle"></i>
                ${text}
            `;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 4000);
        }
    </script>
</body>
</html>
